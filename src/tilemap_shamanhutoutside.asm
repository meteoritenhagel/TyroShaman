INCLUDE "./include/hardware.inc"

SECTION "ShamanHutOutside Tilemap", ROMX, BANK[1]

ShamanHutOutsideStart::
db $4b, $3a, $32, $1c, $3b, $41, $4b, $3a, $32, $1c, $3b, $41, $4b, $3a, $32, $1c, $3b, $41, $4b, $3a, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $4b, $3a, $5f, $5f, $43, $4c, $48, $2f, $31, $49, $43, $4c, $48, $2f, $31, $49, $43, $4c, $48, $30, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $48, $30, $37, $4f, $42, $32, $56, $53, $52, $50, $52, $54, $55, $3f, $00, $00, $45, $32, $1c, $43, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $1c, $43, $41, $4b, $3a, $31, $3d, $3d, $51, $5b, $5e, $36, $36, $0f, $00, $00, $2d, $37, $4f, $42, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $4f, $42, $4c, $48, $2f, $00, $3c, $3e, $46, $4a, $46, $34, $35, $1f, $00, $00, $3b, $41, $4b, $3a, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $4b, $3a, $32, $1c, $3f, $00, $3e, $46, $4a, $46, $4a, $46, $34, $2c, $00, $00, $43, $4c, $48, $30, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $48, $2f, $31, $49, $00, $00, $5a, $5c, $5d, $5a, $5c, $5c, $5d, $2c, $00, $00, $45, $32, $1c, $43, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $1c, $3f, $00, $00, $00, $00, $58, $57, $59, $47, $4e, $4d, $47, $2c, $00, $00, $2d, $37, $4f, $42, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $49, $0f, $00, $00, $00, $00, $39, $33, $2e, $40, $19, $17, $40, $2a, $00, $00, $3b, $41, $4b, $3a, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $23, $24, $25, $16, $22, $22, $16, $00, $00, $00, $43, $4c, $48, $30, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $1d, $03, $13, $1d, $03, $09, $03, $1d, $03, $13, $1d, $03, $09, $00, $00, $00, $45, $32, $1c, $43, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $27, $26, $26, $2b, $29, $26, $2b, $27, $26, $26, $2b, $29, $26, $00, $00, $00, $2d, $37, $4f, $42, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $26, $00, $00, $00, $00, $3b, $41, $4b, $3a, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $2d, $37, $4f, $38, $00, $00, $2d, $37, $4f, $38, $00, $00, $2d, $37, $4f, $42, $4c, $48, $30, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $10, $3b, $41, $4b, $3a, $10, $10, $3b, $41, $4b, $3a, $10, $0e, $3b, $41, $4b, $3a, $32, $1c, $43, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $4f, $42, $4c, $48, $30, $37, $4f, $42, $4c, $48, $30, $37, $4f, $42, $4c, $48, $30, $37, $4f, $42, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $4b, $3a, $32, $1c, $43, $41, $4b, $3a, $32, $1c, $43, $41, $4b, $3a, $32, $1c, $43, $41, $4b, $3a, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $48, $30, $37, $4f, $42, $4c, $48, $30, $37, $4f, $42, $4c, $48, $30, $37, $4f, $42, $4c, $48, $30, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
ShamanHutOutsideEnd::

ShamanHutOutsideLoad::
    ld de, OutsideStart
    ld hl, $9000  ; Tileblock 2
    ld bc, OutsideEnd - OutsideStart
    call Memcopy

    ld de, ShamanHutOutsideStart
    ld hl, $9800  ; Tilemap 0
    ld bc, ShamanHutOutsideEnd - ShamanHutOutsideStart
    call Memcopy

    ld a, $2d
    ld [wUnwalkableTileIdx], a

    ld hl, wCurrentMapCheckExits         ; Point HL to wCurrentMapCheckExits
    ld [hl], LOW(ShamanHutOutsideCheckExit)        ; Store the low byte
    inc hl                               ; Move to the high byte
    ld [hl], HIGH(ShamanHutOutsideCheckExit)       ; Store the high byte

    ld a, $F8
    ld [wPatientY], a
    ld a, $F0
    ld [wPatientX], a

    ld a, [wSuccessfulRitualCounter]
    cp a, 1
    jp nz, .update
    ld a, 24
    ld [wPatientY], a
    ld a, 112
    ld [wPatientX], a
    ld a, 36
    ld [wPatientTileOffset], a
.update
    call UpdatePatientObject
    call UpdatePlayerObject
    ret

ShamanHutOutsideCheckExit::
    ; first check x coordinate
    ld a, [wPlayerX]
    cp a, 80
    jp z, .checkY0
    cp a, 0
    jp z, .checkY1
    ret

    ; if there is a match, check y coordinate

.checkY0
.subcheck0_0
    ld a, [wPlayerY]
    cp a, 56
    jp nz, .subcheck0_1
    ld a, 96
    ld [wPlayerX], a
    ld a, 112
    ld [wPlayerY], a
    ld a, 8
    ld [wVBlankCount], a
    call WaitForVBlankFunction ; wait for 8 VBlanks, since otherwise the game can crash if levels are changed to quickly
    call TurnLcdOff
    call ShamanHutInsideLoad
    jp .final
.subcheck0_1
    ret
.checkY1
.subcheck1_0
    ld a, [wPlayerY]
    cp a, 80
    jp nz, .subcheck1_1
    ld a, 136
    ld [wPlayerX], a
    ld a, 80
    ld [wPlayerY], a
    ld a, 8
    ld [wVBlankCount], a
    call WaitForVBlankFunction ; wait for 8 VBlanks, since otherwise the game can crash if levels are changed to quickly
    call TurnLcdOff
    call WayToTheVillageLoad
    jp .final
.subcheck1_1
    ld a, [wPlayerY]
    cp a, 72
    jp nz, .subcheck1_2
    ld a, 136
    ld [wPlayerX], a
    ld a, 80
    ld [wPlayerY], a
    ld a, 8
    ld [wVBlankCount], a
    call WaitForVBlankFunction ; wait for 8 VBlanks, since otherwise the game can crash if levels are changed to quickly
    call TurnLcdOff
    call WayToTheVillageLoad
    jp .final
.subcheck1_2
    ld a, [wPlayerY]
    cp a, 88
    jp nz, .subcheck1_3
    ld a, 136
    ld [wPlayerX], a
    ld a, 80
    ld [wPlayerY], a
    ld a, 8
    ld [wVBlankCount], a
    call WaitForVBlankFunction ; wait for 8 VBlanks, since otherwise the game can crash if levels are changed to quickly
    call TurnLcdOff
    call WayToTheVillageLoad
    jp .final
.subcheck1_3
    ret
.final
    ld a, LCDCF_ON | LCDCF_BGON | LCDCF_OBJON
    ld [rLCDC], a
    ret
